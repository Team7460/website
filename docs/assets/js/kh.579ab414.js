var BORDER_STYLE="1px solid #bbb",CSS_TRANSFORM=null,CSS_TRANSFORM_ORIGIN=null,POSSIBLE_TRANSFORM_PREFIXES=["-webkit-","-moz-","-o-","-ms-",""],khFirst=!1;function getCssTransform(){var t,e,o=document.createElement("div");for(t=0;t<POSSIBLE_TRANSFORM_PREFIXES.length;t++)if(e=POSSIBLE_TRANSFORM_PREFIXES[t],o.style.setProperty(e+"transform","rotate(1rad) scaleX(2)",null),o.style.getPropertyValue(e+"transform"))return CSS_TRANSFORM=e+"transform",void(CSS_TRANSFORM_ORIGIN=e+"transform-origin");throw alert("Your browser doesn't support CSS tranforms!"),"Your browser doesn't support CSS tranforms!"}function circleGridObjInt(t,e,o,n,i){var a,l;return t<i.left?(a=i.left-t,e<i.top?a*a+(l=i.top-e)*l<=n:e<=i.bottom?a<=o:a*a+(l=e-i.bottom)*l<=n):t<=i.right?e<i.top?i.top-e<=o:e<=i.bottom||e-i.bottom<=o:(a=t-i.right,e<i.top?a*a+(l=i.top-e)*l<=n:e<=i.bottom?a<=o:a*a+(l=e-i.bottom)*l<=n)}function getClosestPoint(t,e,o){return t<o.left?(o.left-t,e<o.top?[o.left,o.top]:e<=o.bottom?[o.left,e]:[o.left,o.bottom]):t<=o.right?e<o.top?[t,o.top]:e<=o.bottom?[t,e]:[t,o.bottom]:(t-o.right,e<o.top?[o.right,o.top]:e<=o.bottom?[o.right,e]:[o.right,o.bottom])}function gridObjVol(t){return t.w*t.h*Math.min(t.w,t.h)}function StickyNodes(){var t=[],e=[],o={a:1,b:1,big:1,body:1,cite:1,code:1,dd:1,div:1,dt:1,em:1,font:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,i:1,label:1,legend:1,li:1,p:1,pre:1,small:1,span:1,strong:1,sub:1,sup:1,td:1,th:1,tt:1};function n(e){null!=e&&(e.khIgnore=!0,e.style.border=BORDER_STYLE,t.push(e))}function i(t){var e;for(e=0;e<t.arrs.length;e++)t.arrs[e][t.idxs[e]]=void 0;t.el.style.visibility="hidden",t.el.khPicked=!0,delete t.arrs,delete t.idxs}this.addDomNode=n,this.addWords=function(t){var e=[];function i(t){return t.tagName&&o[t.tagName.toLowerCase()]}!function t(o,n){var a,l;if(n&&o.nodeType===Node.TEXT_NODE&&o.nodeValue.trim().length>0)e.push(o);else if(o.childNodes&&!o.khIgnore)for(n=i(o),a=0,l=o.childNodes.length;a<l;a++)t(o.childNodes[a],n)}(t,i(t)),e.map(function(t){var e,o,i=t.parentNode,a=t.nodeValue.split(/\s+/),l=t.nodeValue.split(/\S+/),r=Math.max(a.length,l.length);for(l.length>0&&0===l[0].length&&l.shift(),e=0;e<r;e++)e<a.length&&a[e].length>0&&((o=document.createElement("span")).innerHTML=a[e],i.insertBefore(o,t),n(o)),e<l.length&&l[e].length>0&&(o=document.createTextNode(l[e]),i.insertBefore(o,t));i.removeChild(t)})},this.addTagNames=function(t,e){var o,i,a,l,r=t.tagName&&t.tagName.toLowerCase();if(!t.khIgnore&&(-1!==e.indexOf(r)&&n(t),t.getElementsByTagName))for(o=0;o<e.length;o++)for(i=0,l=(a=t.getElementsByTagName(e[o])).length;i<l;i++)a[i].khIgnore||n(a[i])},this.finalize=function(o,n){var i,a,l,r,s,c,d,h,u,f,p,m=Math.floor(o/100)+1,g=Math.floor(n/100)+1;for(e=new Array(m),i=0;i<m;i++)e[i]=new Array(g);for(l=0,r=t.length;l<r;l++)if(!(d=t[l]).khPicked)for(u=jQuery(d).offset(),f=jQuery(d).width(),p=jQuery(d).height(),h={el:t[l],left:u.left,right:u.left+f,top:u.top,bottom:u.top+p,w:f,h:p,x:u.left+f/2,y:u.top+p/2,diag:Math.sqrt((f*f+p*p)/4),arrs:[],idxs:[]},s=Math.floor(h.left/100),c=Math.floor(h.top/100),m=Math.floor((h.left+h.w)/100)+1,g=Math.floor((h.top+h.h)/100)+1,i=s;i<m;i++)for(a=c;a<g;a++)void 0===e[i]&&(e[i]=[]),void 0===e[i][a]?e[i][a]=[h]:e[i][a].push(h),h.arrs.push(e[i][a]),h.idxs.push(e[i][a].length-1)},this.removeIntersecting=function(t,o,n,a){var l,r,s,c,d,h=n*n,u=Math.floor((t-n)/100),f=Math.floor((o-n)/100),p=Math.floor((t+n)/100)+1,m=Math.floor((o+n)/100)+1;for(l=u;l<p;l++)if(void 0!==e[l])for(r=f;r<m;r++)if(void 0!==(s=e[l][r]))for(c=0;c<s.length;c++)void 0!==(d=s[c])&&circleGridObjInt(t,o,n,h,d)&&a(d)&&i(d)}}function PlayerBall(t,e,o,n){var i,a,l,r=300,s=300,c=0,d=0,h=20,u=0,f=1e4,p=1e4,m=[],g=o.color,v=0,b=0,y=!1,M=o.VOL_MULT,k=o.MAX_ATTACHED_VISIBLE,S=o.CHECK_VOLS,w=0,I=0;function T(){return 4*Math.PI*h*h*h/3}function x(t){var e=getClosestPoint(r,s,t),o=e[0]-r,a=e[1]-s,l=Math.sqrt(o*o+a*a),c=0-w,d=e[0]-t.left,u=e[1]-t.top,f=Math.atan2(a,o)-w,p=l*Math.cos(f),g=l*Math.sin(f),v=t.el.cloneNode(!0),b=jQuery(t.el),y={el:v,attX:p,attY:g,attT:"translate("+Math.round(p)+"px,"+Math.round(g)+"px) rotate("+c+"rad)",r:l,offTh:f,offPhi:0-I,diag:t.diag,removeR:l+t.diag,visible:!1,display:b.css("display")};m.push(y),function(t){var e=T()+gridObjVol(t)*M;h=Math.pow(3*e/(4*Math.PI),1/3)}(t),v.style.position="absolute",v.style.left=-d+"px",v.style.top=-u+"px",v.style.setProperty(CSS_TRANSFORM_ORIGIN,d+"px "+u+"px",null),v.style.display="none",v.style.color=b.css("color"),v.style.textDecoration=b.css("text-decoration"),v.style.fontSize=b.css("font-size"),v.style.fontWeight=b.css("font-weight"),v.khIgnore=!0,i.appendChild(v),n&&n.play_pop()}function E(t){return!(S&&gridObjVol(t)>T())&&(x(t),!0)}function P(t){var e=w+t.offTh,o=I+t.offPhi,n=t.r*Math.cos(e),i=t.r*Math.sin(e),a=t.r*Math.cos(w-t.offTh+Math.PI)-n,l=t.r*Math.sin(w-t.offTh+Math.PI)-i,c=(1-Math.cos(o))/2,d=n+c*a,u=i+c*l,f=t.r*Math.sin(o);return f<0&&Math.sqrt(d*d+u*u)+t.diag<h?(t.visible&&(t.visible=!1,t.el.style.display="none"),!1):(t.visible||(t.visible=!0,t.el.style.display=t.display),t.el.style.zIndex=f>0?501:499,t.el.style.setProperty(CSS_TRANSFORM,"translate("+r+"px,"+s+"px) rotate("+w+"rad) scaleX("+Math.cos(o)+") "+t.attT,null),!0)}function C(t){i.removeChild(t.el),delete t.el}this.init=function(){(a=document.createElement("canvas")).width=2*h,a.height=2*h,a.style.cssText="position: absolute; z-index: 500;",t.appendChild(a),l=a.getContext("2d"),i=document.createElement("div"),t.appendChild(i)},this.setRadius=function(t){h=t},this.getState=function(){return{x:r,y:s,vx:c,vy:d,radius:h,th:w,phi:I}},this.setState=function(t){r=t.x,s=t.y,c=t.vx,d=t.vy,h=t.radius,w=t.th,I=t.phi},this.setXY=function(t,e){r=t,s=e},this.setTh=function(t){w=t},this.setPhi=function(t){I=t},this.setColor=function(t){g=t},this.setDocSize=function(t,e){f=t,p=e},this.setAccel=function(t){y=t},this.setAccelTarget=function(t,e){v=t,b=e},this.updatePhysics=function(){var t,o,i,a=r,l=s,u=!1;y?(i=Math.atan2(b-s,v-r),c+=.5*Math.cos(i),d+=.5*Math.sin(i)):(c*=.95,d*=.95),(r+=c)-h<0?(u=!0,r=h+1,c=-c):r+h>f&&(u=!0,r=f-h-1,c=-c),(s+=d)-h<0?(u=!0,s=h+1,d=-d):s+h>p&&(u=!0,s=p-h-1,d=-d),0===c&&0===d||(w=Math.atan2(d,c),t=r-a,o=s-l,I-=Math.sqrt(t*t+o*o)/h),e.removeIntersecting(r,s,h,E),this.draw(),u&&n&&n.play_bounce()},this.draw=function(){var t,e,o=0;for(function(){var t,e,o,n,i,c,d,f,p,m,v;for(a.style.left=r-h+"px",a.style.top=s-h+"px",h!=u&&(a.width=2*h+1,a.height=2*h+1,u=h),l.clearRect(0,0,2*h,2*h),l.fillStyle="#fff",l.beginPath(),l.arc(h,h,h-1,0,2*Math.PI,!0),l.fill(),l.strokeStyle=g,l.beginPath(),l.arc(h,h,h-1,0,2*Math.PI,!0),l.stroke(),l.fillStyle=g,t=h+h*Math.cos(w+Math.PI/16),e=h+h*Math.sin(w+Math.PI/16),o=h+h*Math.cos(w-Math.PI/16),n=h+h*Math.sin(w-Math.PI/16),i=h+h*Math.cos(w+15*Math.PI/16)-t,c=h+h*Math.sin(w+15*Math.PI/16)-e,d=0;d<2*Math.PI;d+=Math.PI/7)f=(1-Math.cos(I+d))/2,p=(1-Math.cos(I+d+Math.PI/32))/2,m=Math.sin(I+d),v=Math.sin(I+d+Math.PI/32),m>0&&v>0&&(l.beginPath(),l.moveTo(t+f*i,e+f*c),l.lineTo(t+p*i,e+p*c),l.lineTo(o+p*i,n+p*c),l.lineTo(o+f*i,n+f*c),l.fill())}(),t=m.length;--t>=0;)if((e=m[t]).removeR<h)m.splice(t,1).map(C);else if(P(e)&&++o>k){m.splice(0,t).map(C);break}}}function preventDefault(t){return t.preventDefault(),t.returnValue=!1,!1}function Game(t,e,o){var n;function i(){n.setDocSize(jQuery(document).width()-5,jQuery(document).height()-5)}(n=new PlayerBall(t,e,o,!1)).init(),n.setXY(300,300),window.scrollTo(0,200),i(),document.addEventListener("touchstart",function(t){if(1===t.touches.length)return n.setAccel(!0),preventDefault(t)},!0),document.addEventListener("touchmove",function(t){n.setAccelTarget(t.touches[0].pageX,t.touches[0].pageY)},!0),document.addEventListener("touchend",function(t){if(0===t.touches.length)return n.setAccel(!1),preventDefault(t)},!0),-5!==o.MOUSEB&&(document.addEventListener("mousemove",function(t){n.setAccelTarget(t.pageX,t.pageY)},!0),document.addEventListener("mousedown",function(t){if(t.button===o.MOUSEB)return n.setAccel(!0),preventDefault(t)},!0),document.addEventListener("mouseup",function(t){if(t.button===o.MOUSEB)return n.setAccel(!1),preventDefault(t)},!0),0===o.MOUSEB?document.addEventListener("click",function(t){if(0===t.button)return preventDefault(t)},!0):2===o.MOUSEB&&document.addEventListener("contextmenu",preventDefault,!0)),setInterval(function(){n.updatePhysics()},25),setInterval(i,1e3)}function whenAllLoaded(t,e,o){o.finalize(jQuery(document).width(),jQuery(document).height()),jQuery("#loadingp").empty(),jQuery("<button>Start!</button>").click(function(){var n,i;jQuery("#bgmusicc").attr("checked")&&((n=document.getElementById("khbgmusic"))||((n=document.createElement("audio")).id="khbgmusic",n.loop="loop",n.src="http://kathack.com/js/katamari.mp3",t.appendChild(n)),n.play()),i={color:jQuery("#khcolor").val(),VOL_MULT:parseFloat(jQuery("#vol_mult").val()),MAX_ATTACHED_VISIBLE:parseInt(jQuery("#maxAtt").val(),10),CHECK_VOLS:!!jQuery("#checkv").attr("checked"),MOUSEB:parseInt(jQuery("#mouseb").val(),10)},t.removeChild(e),new Game(t,o,i)}).appendTo("#loadingp")}function buildPopup(t){var e=document.createElement("div");return e.style.cssText="position: fixed;left: 50%;top: 50%;width: 400px;margin-left:-200px;margin-top:-150px;border:1px solid black;background-color:white;color:black;padding:20px;font-size:13px;text-align:left;z-index:501;",e.innerHTML='<h1 style="font-size:16pt"><a href="http://kathack.com/" style="color:blue;text-decoration:none;">Katamari!</a></h1><button style="position:absolute;top:0;right:0;">X</button><p>Controls: Hold down <b><select id="mouseb"><option value="0">Left-Click</option><option value="2" selected="selected">Right-Click</option><option value="-5">Touch</option></select></b> to control the ball!</p><div><label>Background Music? <input id="bgmusicc" type="checkbox" checked="checked" /></label></div><div style="text-align:right; color:gray;"><label>Katamari Color: <select id="khcolor"><option value="#ff0000" style="background-color:#ff0000;color:#ff0000"> r </option><option value="#00ff00" style="background-color:#00ff00;color:#00ff00"> g </option><option value="#0000ff" style="background-color:#0000ff;color:#0000ff"> b </option><option selected="selected" value="#7D26CD" style="background-color:#7D26CD;color:#7D26CD"> p </option></select></label><br /> <label title="Lower this if the game gets slow.">Max Attached Objects: <select id="maxAtt"><option>25</option><option>50</option><option selected="selected">75</option><option>100</option><option>9000</option></select></label><br /><label title="How much to grow when an object is picked up.">Growth Speed: <input id="vol_mult" type="text" size="6" value="1.0" /></label><br /><label title="Bigger objects require a bigger katamari to pick up.">Realistic Pickups? <input id="checkv" type="checkbox" checked="checked" /></label></div><p id="loadingp">Loading!</p>',t.appendChild(e),e.getElementsByTagName("button")[0].addEventListener("click",function(){t.removeChild(e)},!0),e}function main(){var t,e,o;(t=document.createElement("div")).khIgnore=!0,document.body.appendChild(t),o=buildPopup(t),setTimeout(function(){var n,i,a;for(window.khNodes.addWords(document.body),n=0,i=document.body.childNodes.length;n<i;n++)a=document.body.childNodes[n],window.khNodes.addTagNames(a,["button","canvas","iframe","img","input","select","textarea"]);e=setInterval(function(){window.jQuery&&(clearInterval(e),whenAllLoaded(t,o,window.khNodes))},100)},0)}window.khNodes||(khFirst=!0,window.khNodes=new StickyNodes),getCssTransform(),window.noMain||main();